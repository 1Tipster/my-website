---
import BaseLayout from './BaseLayout.astro';

interface Attachment {
  url: string;
  label: string;
}

interface Props {
  title: string;
  description: string;
  date: Date;
  endDate?: Date;
  location?: string;
  url?: string;
  photos?: string[];
  attachments?: Attachment[];
}

const { title, description, date, endDate, location, url, photos = [], attachments = [] } = Astro.props;

function getFileType(fileUrl: string): { ext: string; color: string } {
  const ext = fileUrl.split('.').pop()?.toLowerCase() ?? '';
  const colors: Record<string, string> = {
    pdf:  '#dc2626',
    doc:  '#2563eb', docx: '#2563eb',
    xls:  '#16a34a', xlsx: '#16a34a',
    ppt:  '#ea580c', pptx: '#ea580c',
    jpg:  '#7c3aed', jpeg: '#7c3aed', png: '#7c3aed', gif: '#7c3aed', webp: '#7c3aed',
  };
  return { ext: ext.toUpperCase() || 'FILE', color: colors[ext] ?? '#6b7280' };
}

function formatDate(d: Date): string {
  return d.toLocaleDateString('en-us', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

function formatTime(d: Date): string {
  return d.toLocaleTimeString('en-us', {
    hour: 'numeric',
    minute: '2-digit',
  });
}

const isPast = date < new Date();
---

<BaseLayout title={`${title} | Events`} description={description}>
  <article class="max-w-3xl mx-auto">
    <div class="mb-8">
      <a href="/events" class="text-sm text-[var(--color-accent)] hover:underline">&larr; All events</a>
    </div>

    <h1 class="text-4xl font-bold mb-3">{title}</h1>

    <div class="flex flex-wrap items-center gap-3 text-sm text-[var(--color-text-secondary)] mb-6">
      {isPast && (
        <span class="text-xs px-2 py-1 rounded-full bg-[var(--color-text-secondary)]/10">Past event</span>
      )}
      <time datetime={date.toISOString()}>
        {formatDate(date)} at {formatTime(date)}
      </time>
      {endDate && (
        <span>â€” {formatDate(endDate)} at {formatTime(endDate)}</span>
      )}
    </div>

    {location && (
      <div class="flex items-center gap-1.5 text-sm text-[var(--color-text-secondary)] mb-4">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        {location}
      </div>
    )}

    {url && (
      <div class="mb-6">
        <a
          href={url}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-1 text-sm text-[var(--color-accent)] hover:underline"
        >
          Event link &nearr;
        </a>
      </div>
    )}

    <div class="prose">
      <slot />
    </div>

    {attachments.length > 0 && (
      <section class="mt-10">
        <h2 class="text-xl font-semibold mb-4">Attachments</h2>
        <ul class="flex flex-col gap-2">
          {attachments.map((file) => {
            const { ext, color } = getFileType(file.url);
            return (
              <li>
                <a
                  href={file.url}
                  download
                  class="inline-flex items-center gap-3 px-4 py-3 rounded-lg border border-[var(--color-border)] hover:border-[var(--color-accent)] transition-colors group w-full sm:w-auto"
                >
                  <!-- Download icon -->
                  <svg class="w-4 h-4 flex-shrink-0 text-[var(--color-text-secondary)] group-hover:text-[var(--color-accent)] transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                  </svg>
                  <span class="text-sm font-medium group-hover:text-[var(--color-accent)] transition-colors">{file.label}</span>
                  <span class="text-xs font-bold px-1.5 py-0.5 rounded text-white flex-shrink-0" style={`background-color: ${color};`}>{ext}</span>
                </a>
              </li>
            );
          })}
        </ul>
      </section>
    )}

    {photos.length > 0 && (
      <section class="mt-12">
        <h2 class="text-2xl font-semibold mb-4">Photos</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
          {photos.map((photo) => (
            <a href={photo} target="_blank" rel="noopener noreferrer" class="block overflow-hidden rounded-lg border border-[var(--color-border)] hover:border-[var(--color-accent)] transition-colors">
              <img src={photo} alt="" class="w-full h-48 object-cover" />
            </a>
          ))}
        </div>
      </section>
    )}
  </article>
</BaseLayout>
